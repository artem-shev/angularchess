!function(){"use strict";angular.module("chessApp",["ngRoute","ngAnimate","chessApp.common"])}(),function(){"use strict";function e(){var e={templateUrl:"components/chessboard/chessboard.html",controller:"MainCtrl",controllerAs:"ctrl"};return e}angular.module("chessApp").directive("chessboard",e)}(),function(){"use strict";function e(e,r,o){function t(e,r){if(!n.position){if(!r.figure)return;return s=r,s.isSelected=!0,n.figureId=s.figure.id,void(n.position={row:r.row,col:r.col})}a=r,!a.isSelected&&(a.isSelected=!0),n.dest={row:r.row,col:r.col};var o=i.board.validateMove(n);o?(l&&(l.start!==s&&l.start!==a&&(l.start.isSelected=!1),l.finish!==s&&l.finish!==a&&(l.finish.isSelected=!1)),l={start:s,finish:a}):(l||(delete s.isSelected,delete a.isSelected),"object"==typeof l&&(s!==l.start&&s!==l.finish&&delete s.isSelected,a!==l.start&&a!==l.finish&&delete a.isSelected)),i.board.makeMove(o),n={},s=void 0,a=void 0}var i=this;i.player1=new o.constructor,i.player2=new o.constructor;var l,s,a,n={};i.board=new r.constructor(8,8,i.player1,i.player2),i.selectCell=t}angular.module("chessApp").controller("MainCtrl",e),e.$inject=["figureService","boardService","userService"]}(),angular.module("chessApp").run(["$templateCache",function(e){e.put("components/chessboard/chessboard.html",'<div class="set">\r\n\t<div class="controlls">\r\n\t\t<p><button ng-click="ctrl.board.start()" ng-disabled="ctrl.board.gameIsStarted">Start</button></p> \r\n\t\t<p><button ng-click="ctrl.board.restart()">Restart</button></p>\r\n\t</div>\t\r\n\t<div class="info">\r\n\t\t<div>\r\n\t\t\t<div ng-if="ctrl.player1">\r\n\t\t\t\tPlayer 1: <br>\r\n\t\t\t\tname: {{ctrl.player1.name}}\r\n\t\t\t\t<!-- value, time, killed figures -->\r\n\t\t\t</div>\r\n\t\t\t<br>\r\n\t\t\t<div ng-if="ctrl.player2">\r\n\t\t\t\tPlayer 2: <br>\r\n\t\t\t\tname: {{ctrl.player2.name}}\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n<div class="board">\r\n\t<div ng-repeat="row in ctrl.board.rows" class="row">\r\n\t\t<div ng-repeat="cell in row.cells" class="cell" ng-class="{\'black-cell\': cell.black}" ng-click="ctrl.selectCell($event, cell)">\r\n\t\t\t<img ng-if="cell.figure" ng-src="{{cell.figure.img}}" alt="" class="figure">\r\n\t\t\t\r\n\t\t\t<div ng-if="cell.rowName" class="row-name">{{cell.rowName}}</div>\r\n\t\t\t<div ng-if="cell.colName" class="coll-name">{{cell.colName}}</div>\r\n\t\t\t<div ng-if="cell.isSelected" class="selected"></div>\r\n\t\t</div>\t\t\t\r\n\t</div>\t\r\n</div>\r\n\r\n<div>\r\n\t<p ng-repeat="move in ctrl.board.movesLog">\r\n\t{{move.figure.name}} {{move.startCell.cellName}} ... {{move.finishCell.cellName}} - {{move.typeOfMove}} {{move.victim.name}} {{move.victim.id}}\r\n\t</p>\r\n</div>\r\n\r\n<div class="figure-select" ng-if="ctrl.board.figureTransform.available">\r\n\t<button \r\n\t\tng-click="ctrl.board.pawnTransform(ctrl.board.figureTransform, figure)"\r\n\t\tng-repeat="figure in ctrl.board.figureTransform.player.figuresExamples"\r\n\t\tclass="figure-select__btn"><img ng-src="{{figure.img}}" alt="{{figure.name}}" class="figure"></button>\r\n\r\n\t<span ng-click="ctrl.board.figureTransform.available = false" class="figure-select--ctrl">x</span>\r\n</div>')}]),function(){"use strict";angular.module("chessApp.common",[])}(),function(){"use strict"}(),function(){"use strict";function e(e){function r(e){var r=this;s?r.color="black":r.color="white",r.isBlack=s,r.name=e||r.color+" player",r.figures=[],r.deadFigures=[],r.figuresExamples=[],s=!s}var o={constructor:r},t=e.constructors,i=[t.Rook,t.Knight,t.Bishop,t.Queen,t.King,t.Bishop,t.Knight,t.Rook],l=[t.Bishop,t.Knight,t.Rook,t.Queen],s=!1;return r.prototype.defaultStart=function(){var e,r,o=this;o.isBlack?(e=8,r=7):(e=1,r=2),l.forEach(function(e,r){o.figuresExamples.push(new e(o))}),i.forEach(function(i,l){o.figures.push(new i(o,{row:e,col:l+1})),o.figures.push(new t.Pawn(o,{row:r,col:l+1}))})},r.prototype.restart=function(){var e=this;e.figures=[],e.figuresExamples=[],e.defaultStart()},r.prototype.getPiecesValue=function(){var e=this,r=0;return e.figures.forEach(function(e){e.isDead||(r+=e.value)}),r},r.prototype.buryFigure=function(e){var r=this,o=r.figures.indexOf(e);r.figures.splice(o,1),r.deadFigures.push(e)},r.prototype.addFigure=function(e,r){var o,i=this,l=_.find(i.deadFigures,{name:e.name});if(l){var s=i.deadFigures.indexOf(l);i.deadFigures.splice(s,1),l.resurect(r),o=l}else{var a=_.find(t,{name:e.name});o=new a(i,r)}return i.figures.push(o),o},o}angular.module("chessApp.common").factory("userService",e),e.$inject=["figureService"]}(),function(){"use strict";function e(){function e(e,r){var o=this;o.isBlack=e.isBlack,o.cordinats=r,o.firstMove=!0,o.id=c,c++}function r(r,o){var t=this;e.apply(t,arguments),t.moveSettings={movesDescr:[],moveLength:8,jump:!1}}function o(r,o){var t=this;switch(e.apply(t,arguments),t.name="pawn",t.value=1,t.isBlack?(t.color="black",t.img="img/bP.png"):(t.color="white",t.img="img/wP.png"),t.color){case"white":t.moveDir=1;break;case"black":t.moveDir=-1}}function t(e,o){var t=this;r.apply(t,arguments),t.name="Bishop",t.value=3,t.isBlack?(t.color="black",t.img="img/bB.png"):(t.color="white",t.img="img/wB.png"),t.moveSettings={movesDescr:[{row:1,col:1},{row:1,col:-1},{row:-1,col:1},{row:-1,col:-1}],moveLength:8,jump:!1}}function i(e,o){var t=this;r.apply(t,arguments),t.name="Knight",t.value=3,t.isBlack?(t.color="black",t.img="img/bN.png"):(t.color="white",t.img="img/wN.png"),t.moveSettings={movesDescr:[{row:2,col:1},{row:2,col:-1},{row:-2,col:1},{row:-2,col:-1},{row:1,col:2},{row:-1,col:2},{row:1,col:-2},{row:-1,col:-2}],moveLength:1,jump:!0}}function l(e,o){var t=this;r.apply(t,arguments),t.name="Rook",t.value=5,t.isBlack?(t.color="black",t.img="img/bR.png"):(t.color="white",t.img="img/wR.png"),t.moveSettings={movesDescr:[{row:0,col:1},{row:0,col:-1},{row:1,col:0},{row:-1,col:0}],moveLength:8,jump:!1}}function s(e,o){var t=this;r.apply(t,arguments),t.name="Queen",t.value=9,t.isBlack?(t.color="black",t.img="img/bQ.png"):(t.color="white",t.img="img/wQ.png"),t.moveSettings={movesDescr:[{row:0,col:1},{row:0,col:-1},{row:1,col:0},{row:-1,col:0},{row:1,col:1},{row:-1,col:-1},{row:-1,col:1},{row:1,col:-1}],moveLength:8,jump:!1}}function a(e,o){var t=this;r.apply(t,arguments),t.name="King",t.isBlack?(t.color="black",t.img="img/bK.png"):(t.color="white",t.img="img/wK.png"),t.value=0,t.moveSettings={movesDescr:[{row:1,col:1},{row:1,col:0},{row:1,col:-1},{row:0,col:-1},{row:-1,col:-1},{row:-1,col:0},{row:-1,col:1},{row:0,col:1},{row:0,col:2,custom:{name:"castling",long:!1}},{row:0,col:-2,custom:{name:"castling",long:!0}}],moveLength:1,jump:!1}}var n={constructors:{Pawn:o,Bishop:t,Knight:i,Rook:l,Queen:s,King:a},restrictions:{rows:8,cols:8}},c=1,u=n.restrictions.rows,f=n.restrictions.cols;return e.prototype.move=function(e){var r=this;r.cordinats=e,r.firstMove=!1},e.prototype.death=function(){var e=this;e.cordinats=void 0,e.isDead=!0},r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.getAvailableMoves=function(e,r,o){var t=this;if(!t.isDead){var i,l,s,a,n=t.moveSettings,c=[],g=t.cordinats;return n.movesDescr.forEach(function(v){for(i=1;i<=n.moveLength&&(l=i*v.row+g.row,s=i*v.col+g.col,0!==l&&0!==s);i++){a=v.custom?{figureId:t.id,color:t.color,position:g,dest:{row:l,col:s},type:v.custom}:{figureId:t.id,color:t.color,position:g,dest:{row:l,col:s},kill:!0,basic:!0},l>0&&l<=u&&s>0&&s<=f&&c.push(a);var p;if(p=_.find(e,{row:l,col:s})||{},!o||p!==r){if(r&&p===r&&!o)break;if(p.figure)break}}}),c}},r.prototype.resurect=function(e){var r=this;r.cordinats=e,delete r.isDead},o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.getAvailableMoves=function(e){function r(e){var r=e.dest.row>0&&e.dest.row<=u,o=e.dest.col>0&&e.dest.col<=f;if(r&&o)return!0}var o,t,i=this,l=[],s=i.moveDir,a=i.cordinats;o={figureId:i.id,color:i.color,position:a,dest:{row:1*s+a.row,col:0+a.col},kill:!1,basic:!0},1!==o.dest.row&&o.dest.row!==u||(o.transform=!0),r(o)&&l.push(o),i.firstMove&&(o={figureId:i.id,color:i.color,position:a,dest:{row:2*s+a.row,col:0+a.col},kill:!1,basic:!0,passing:!0},r(o)&&l.push(o));for(var n=1;n<=2;n++){switch(n){case 1:t=1;break;case 2:t=-1}o={figureId:i.id,color:i.color,position:a,dest:{row:1*s+a.row,col:1*t+a.col},kill:!0,basic:!1},1!==o.dest.row&&o.dest.row!==u||(o.transform=!0),r(o)&&l.push(o)}return l},t.prototype=Object.create(r.prototype),t.prototype.constructor=t,i.prototype=Object.create(r.prototype),i.prototype.constructor=i,l.prototype=Object.create(r.prototype),l.prototype.constructor=l,s.prototype=Object.create(r.prototype),s.prototype.constructor=s,a.prototype=Object.create(r.prototype),a.prototype.constructor=a,a.prototype.getAvailableMoves=function(e){var o=this;return o.firstMove||10!==o.moveSettings.movesDescr.length||o.moveSettings.movesDescr.splice(o.moveSettings.movesDescr.length-2,2),r.prototype.getAvailableMoves.apply(o,arguments)},n}angular.module("chessApp.common").factory("figureService",e)}(),function(){"use strict";function e(){function e(e,r,o,t){function i(){a(),n(),c(),g.figures[0]&&(g.bindFigures(),g.getAvailableMoves(g.cells))}function l(e,r){for(var o=[],t=e.charCodeAt(0),i=r.charCodeAt(0),l=t;l<=i;l++)o.push(String.fromCharCode(l));return o}function s(e,r){for(var o=[],t=e;t<=r;t++)o.push(t);return o}function a(){for(g.rows=[],f=0;f<e;f++)g.rows.push({row:f+1,cells:[],firstCellBlack:d}),d=!d;g.rows=g.rows.reverse()}function n(){g.rows.forEach(function(e){for(f=0;f<r;f++){var o={row:e.row,col:f+1,black:e.firstCellBlack,cellName:u(f+1)+e.row};0===f&&(o.rowName=e.row),1===e.row&&(o.colName=u(f+1)),e.cells.push(o),e.firstCellBlack=!e.firstCellBlack}})}function c(){g.cells=[],_.each(g.rows,function(e){g.cells.push(e.cells)}),g.cells=_.flatten(g.cells)}function u(e){if(e<=m.cols.length)return m.cols[e-1];throw new Error("unexpected number of columns")}var f,g=this,v=l("a","z"),p=s(1,26),d=!0,m={rows:p.slice(0,e),cols:v.slice(0,r)};g.whiteTurn=!0,g.player1=o||{},g.player2=t||{},g.players=[o,t],g.figures=_.concat(g.player1.figures,g.player2.figures),g.movesLog=[],g.deadFigures=[],i()}var r={constructor:e};return e.prototype.bindFigures=function(){var e=this;_.each(e.figures,function(r){_.find(e.cells,r.cordinats).figure=r})},e.prototype.getAvailableMoves=function(e){var r=this;r.availableMoves=[],_.each(r.figures,function(o,t){r.availableMoves.push(o.getAvailableMoves(e)),t===r.figures.length-1&&(r.availableMoves=_.flatten(r.availableMoves))})},e.prototype.removeFigure=function(e){var r=this,o=r.figures.indexOf(e),t=_.find(r.players,{color:e.color});t.buryFigure(e),r.deadFigures.push(e),r.figures.splice(o,1)},e.prototype.resurectFigure=function(e){},e.prototype.start=function(){var e=this;e.player1.defaultStart(),e.player2.defaultStart(),e.figures=_.concat(e.player1.figures,e.player2.figures),e.bindFigures(),e.getAvailableMoves(e.cells),e.sortFigures(),e.gameIsStarted=!0,e.gameStatus={currentPlay:!0}},e.prototype.restart=function(){var e=this;e.cells.forEach(function(e){e.figure&&delete e.figure,e.isSelected&&delete e.isSelected}),e.player1.restart(),e.player2.restart(),e.whiteTurn=!0,e.movesLog=[],e.deadFigures=[],e.figures=_.concat(e.player1.figures,e.player2.figures),e.figureTransform=void 0,e.bindFigures(),e.getAvailableMoves(e.cells),e.sortFigures(),e.gameStatus={currentPlay:!0}},e.prototype.sortFigures=function(){var e=this;e.players.forEach(function(r,o){var t=e.figures[r.color]={};t.king=_.find(r.figures,{name:"King"}),t.longRangeFigures=[],r.figures.forEach(function(e){if(!e.isDead)switch(e.name){case"Rook":case"Bishop":case"Queen":t.longRangeFigures.push(e)}})})},e.prototype.validateMove=function(e){var r=this;if(r.movesLog.length>1)var o=r.movesLog[r.movesLog.length-1];var t={startCell:_.find(r.cells,e.position),finishCell:_.find(r.cells,e.dest),dest:e.dest,availableMove:_.find(r.availableMoves,e)},i=t.startCell.figure,l=t.finishCell.figure;if(r.gameStatus.currentPlay&&!(t.startCell.figure.isBlack&&r.whiteTurn||!t.startCell.figure.isBlack&&!r.whiteTurn)&&t.availableMove){if("King"!==i.name){var s=r.validateKingsMoves(e,t,!0);if(!s)return;if(!l&&t.availableMove.basic)return t.typeOfMove="basic",t.availableMove.passing&&(t.typeOfMove="passing",t.passingThrow={col:t.finishCell.col},i.isBlack?t.passingThrow.row=t.finishCell.row+1:t.passingThrow.row=t.finishCell.row-1),t;if(l&&t.availableMove.kill&&l.isBlack!=i.isBlack)return t.typeOfMove="killMove",t}if("pawn"===i.name&&o&&"passing"===o.typeOfMove){var a=o.figure;if(t.secondFigure=a,a&&t.availableMove.kill&&i.isBlack!==a.isBlack){var n=t.availableMove.dest.col===o.passingThrow.col&&t.availableMove.dest.row===o.passingThrow.row;if(n)return t.typeOfMove="inPassingKill",t.secondFigureCell=_.find(r.cells,{figure:a}),t}}if("King"===i.name){var c=r.validateKingsMoves(e,t);return!!c&&c}}},e.prototype.validateKingsMoves=function(e,r,o){var t,i,l,s,a,n,c,u,f,g,v,p,d=this,m=r.startCell.figure,h=r.startCell,w=r.finishCell,b=m.color,y=!0,M=!0;if(t="white"===b?"black":"white",i=d.figures[m.color].king,l={row:i.cordinats.row,col:i.cordinats.col},s=_.filter(d.availableMoves,{color:t,dest:l,kill:!0}),o)switch(s.length){case 0:return d.figures[t].longRangeFigures.forEach(function(e){e.isDead||(c=e.getAvailableMoves(d.cells,r.startCell,!0),u=_.find(c,{dest:l}),u&&(n=!0))}),!n;case 1:return a=_.find(d.figures,{id:s[0].figureId}),!(w.col!==a.cordinats.col||w.row!==a.cordinats.row||!r.availableMove.kill)||(f=a.getAvailableMoves(d.cells,r.finishCell),g=_.find(f,{dest:l}),!g);default:return!1}if(!r.availableMove.type&&"King"===m.name&&(u=[],v=_.find(d.availableMoves,{color:t,kill:!0,dest:{row:w.row,col:w.col}}),0!==s.length&&s.forEach(function(e){a=_.find(d.figures,{id:e.figureId}),c=a.getAvailableMoves(d.cells,h,!0);var r={row:w.row,col:w.col},o=_.find(c,{dest:r});o&&u.push(o)}),!v&&0===u.length)){if(r.finishCell.figure){if(r.finishCell.figure.color===b)return;r.typeOfMove="killMove"}else r.typeOfMove="basic";return r}if(r.availableMove.type&&"castling"===r.availableMove.type.name){if(s=_.find(d.availableMoves,{color:t,dest:{row:h.row,col:h.col}}))return;if(r.availableMove.type.long?r.secondFigureCell=p=_.find(d.cells,{row:e.position.row,col:e.position.col-4}):r.secondFigureCell=p=_.find(d.cells,{row:e.position.row,col:e.position.col+3}),!(p&&p.figure&&"Rook"===p.figure.name&&p.figure.firstMove))return;r.secondFigure=p.figure,r.typeOfMove=r.availableMove.type,r.availableMove.type.long?r.secondFigureDest={row:p.row,col:p.col+3}:r.secondFigureDest={row:p.row,col:p.col-2};var k=d.checkCellsLine(r.startCell,p,!0);if(k.forEach(function(e,o){var i=_.find(d.availableMoves,{color:t,kill:!0,dest:{row:e.row,col:e.col}});r.availableMove.type.long&&0===o&&(i=void 0),e.figure&&(y=!1),i&&(M=!1)}),M&&y)return r}},e.prototype.checkGameOverStates=function(e){var r=this;if(r.figures.length<=4){var o=[];if(r.players.forEach(function(e,r){var t=e.figures;switch(t.length){case 1:"King"===t[0].name&&o.push(!0);break;case 2:var i=_.find(t,{name:"Bishop"}),l=_.find(t,{name:"Knight"}),s=_.find(t,{name:"King"});s&&(i||l)?o.push(!0):o.push(!1);break;default:o.push(!1)}}),o[0]&&o[1])return r.gameStatus={gameOver:!0,case:"draw",reason:"insufficient material"},void console.log("game over",r.gameStatus,o)}var t,i;r.whiteTurn?(t="white",i="black"):(t="black",i="white");var l=r.figures[t].king,s={row:l.cordinats.row,col:l.cordinats.col},a=_.find(r.availableMoves,{color:i,dest:s}),n=_.filter(r.availableMoves,{color:t}),c=[];return n.forEach(function(e,o){var t={figureId:e.figureId,position:e.position,dest:e.dest},i=r.validateMove(t);i&&c.push(e)}),0===c.length?a?(r.gameStatus={gameOver:!0,case:"checkmate",winner:_.find(r.players,{color:i}).name,looser:_.find(r.players,{color:t}).name},void console.log("game over",r.gameStatus)):(r.gameStatus={gameOver:!0,case:"draw",reason:"stalemate"},void console.log("game over",r.gameStatus)):void(e&&(r.hints=c))},e.prototype.getPlayersPiecesValues=function(){var e=this;e.playersPiecesValues={},e.players.forEach(function(r){e.playersPiecesValues[r.color]=r.piecesValue=r.getPiecesValue()})},e.prototype.checkCellsLine=function(e,r,o){var t=this,i=[],l={},s=Math.abs(e.row-r.row),a=Math.abs(e.col-r.col);if(e.row===r.row){l.row=e.row,l.col=Math.min(e.col,r.col);for(var n=0;n<=a;n++)i.push(_.find(t.cells,{row:l.row,col:l.col+n}))}if(e.col===r.col){l.row=Math.min(e.row,r.row),l.col=e.col;for(var n=0;n<=s;n++)i.push(_.find(t.cells,{row:l.row+n,col:l.col}))}return o&&(i.shift(),i.pop()),i},e.prototype.pawnTransform=function(e,r){var o=this,t=e.player,i=e.validation,l=e.validation.finishCell.figure;l.death(),o.removeFigure(l),delete i.finishCell.figure;var s=t.addFigure(r,i.dest),a=o.deadFigures.indexOf(s);a!==-1&&o.deadFigures.splice(a,1),o.figures.push(s),o.sortFigures(),o.bindFigures(),o.getAvailableMoves(o.cells),o.checkGameOverStates(),o.figureTransform=void 0},e.prototype.makeMove=function(e){var r=this;if(e){var o=e.startCell.figure;if("killMove"===e.typeOfMove){var t=e.finishCell.figure;t.death(),r.removeFigure(t),delete e.finishCell.figure}if(o.move(e.dest),e.availableMove.transform){var i=e.startCell.figure;r.figureTransform={available:!0,player:_.find(r.players,{color:i.color}),validation:e}}e.secondFigure&&("castling"===e.typeOfMove.name&&e.secondFigure.move(e.secondFigureDest),"inPassingKill"===e.typeOfMove&&(e.secondFigure.death(),r.removeFigure(e.secondFigure)),delete e.secondFigureCell.figure),delete e.startCell.figure;var l={startCell:e.startCell,finishCell:e.finishCell,typeOfMove:e.typeOfMove,figure:o};"passing"===e.typeOfMove&&(l.passingThrow=e.passingThrow),"killMove"===l.typeOfMove&&(l.victim=t),r.movesLog.push(l),r.bindFigures(),r.getAvailableMoves(r.cells),r.whiteTurn=!r.whiteTurn,r.checkGameOverStates()}},r}angular.module("chessApp.common").service("boardService",e)}();