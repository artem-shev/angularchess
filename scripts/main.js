!function(){"use strict";angular.module("chessApp",["ngRoute","ngAnimate","chessApp.common"])}(),function(){"use strict";function e(){var e={templateUrl:"components/chessboard/chessboard.html",controller:"MainCtrl",controllerAs:"ctrl"};return e}angular.module("chessApp").directive("chessboard",e)}(),function(){"use strict";function e(e,o,r){function t(e,o){if(!c.position){if(!o.figure)return;return i=o,i.isSelected=!0,c.figureId=i.figure.id,void(c.position={row:o.row,col:o.col})}c.dest={row:o.row,col:o.col};var r=l.board.validateMove(c);l.board.makeMove(r),delete i.isSelected,c={},i=void 0}var l=this;l.player1=new r.constructor,l.player2=new r.constructor;var i,c={};l.board=new o.constructor(8,8,l.player1,l.player2),l.selectCell=t}angular.module("chessApp").controller("MainCtrl",e),e.$inject=["figureService","boardService","userService"]}(),angular.module("chessApp").run(["$templateCache",function(e){e.put("components/chessboard/chessboard.html",'<div class="set">\r\n\t<div class="controlls">\r\n\t\t<p><button ng-click="ctrl.board.start()" ng-disabled="ctrl.board.gameIsStarted">Start</button></p> \r\n\t\t<p><button ng-click="ctrl.board.restart()">Restart</button></p>\r\n\t</div>\t\r\n\t<div class="info">\r\n\t\t<div>\r\n\t\t\t<div ng-if="ctrl.player1">\r\n\t\t\t\tPlayer 1: <br>\r\n\t\t\t\tname: {{ctrl.player1.name}}\r\n\t\t\t\t<!-- value, time, killed figures -->\r\n\t\t\t</div>\r\n\t\t\t<br>\r\n\t\t\t<div ng-if="ctrl.player2">\r\n\t\t\t\tPlayer 2: <br>\r\n\t\t\t\tname: {{ctrl.player2.name}}\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n<div class="board">\r\n\t<div ng-repeat="row in ctrl.board.rows" class="row">\r\n\t\t<div ng-repeat="cell in row.cells" class="cell" ng-class="{\'black-cell\': cell.black}" ng-click="ctrl.selectCell($event, cell)">\r\n\t\t\t<img ng-if="cell.figure" ng-src="{{cell.figure.img}}" alt="" class="figure">\r\n\t\t\t\r\n\t\t\t<div ng-if="cell.rowName" class="row-name">{{cell.rowName}}</div>\r\n\t\t\t<div ng-if="cell.collName" class="coll-name">{{cell.collName}}</div>\r\n\t\t\t<div ng-if="cell.isSelected" class="selected"></div>\r\n\t\t</div>\t\t\t\r\n\t</div>\t\r\n</div>\r\n')}]),function(){"use strict";angular.module("chessApp.common",[])}(),function(){"use strict";function e(e){function o(e){var o,r=this;o=i?"black":"white",r.isBlack=i,r.name=e||o+" player",r.figures=[],i=!i}var r={constructor:o},t=e.constructors,l=[t.Rook,t.Knight,t.Bishop,t.Queen,t.King,t.Bishop,t.Knight,t.Rook],i=!1;return o.prototype.defaultStart=function(){var e,o,r=this;r.isBlack?(e=8,o=7):(e=1,o=2),l.forEach(function(l,i){r.figures.push(new l(r,{row:e,col:i+1})),r.figures.push(new t.Pawn(r,{row:o,col:i+1}))})},o.prototype.restart=function(){var e=this;e.figures=[],e.defaultStart()},r}angular.module("chessApp.common").factory("userService",e),e.$inject=["figureService"]}(),function(){"use strict";function e(){function e(e,o){var r=this;r.isBlack=e.isBlack,r.cordinats=o,r.firstMove=!0,r.id=a,a++}function o(o,r){var t=this;e.apply(t,arguments),t.moveSettings={movesDescr:[],moveLength:8,jump:!1}}function r(o,r){var t=this;e.apply(t,arguments),t.name="pawn",t.value=1,t.isBlack?(t.color="black",t.img="img/bP.png"):(t.color="white",t.img="img/wP.png")}function t(e,r){var t=this;o.apply(t,arguments),t.name="Bishop",t.value=3,t.isBlack?(t.color="black",t.img="img/bB.png"):(t.color="white",t.img="img/wB.png"),t.moveSettings={movesDescr:[{row:1,col:1},{row:1,col:-1},{row:-1,col:1},{row:-1,col:-1}],moveLength:8,jump:!1}}function l(e,r){var t=this;o.apply(t,arguments),t.name="Knight",t.value=3,t.isBlack?(t.color="black",t.img="img/bN.png"):(t.color="white",t.img="img/wN.png"),t.moveSettings={movesDescr:[{row:2,col:1},{row:2,col:-1},{row:-2,col:1},{row:-2,col:-1},{row:1,col:2},{row:-1,col:2},{row:1,col:-2},{row:-1,col:-2}],moveLength:1,jump:!0}}function i(e,r){var t=this;o.apply(t,arguments),t.name="Rook",t.value=5,t.isBlack?(t.color="black",t.img="img/bR.png"):(t.color="white",t.img="img/wR.png"),t.moveSettings={movesDescr:[{row:0,col:1},{row:0,col:-1},{row:1,col:0},{row:-1,col:0}],moveLength:8,jump:!1}}function c(e,r){var t=this;o.apply(t,arguments),t.name="Queen",t.value=9,t.isBlack?(t.color="black",t.img="img/bQ.png"):(t.color="white",t.img="img/wQ.png"),t.moveSettings={movesDescr:[{row:0,col:1},{row:0,col:-1},{row:1,col:0},{row:-1,col:0},{row:1,col:1},{row:-1,col:-1},{row:-1,col:1},{row:1,col:-1}],moveLength:8,jump:!1}}function s(e,r){var t=this;o.apply(t,arguments),t.name="King",t.isBlack?(t.color="black",t.img="img/bK.png"):(t.color="white",t.img="img/wK.png"),t.moveSettings={movesDescr:[{row:1,col:1},{row:1,col:0},{row:1,col:-1},{row:0,col:-1},{row:-1,col:-1},{row:-1,col:0},{row:-1,col:1},{row:0,col:1}],moveLength:1,jump:!1}}var n={constructors:{Pawn:r,Bishop:t,Knight:l,Rook:i,Queen:c,King:s}},a=1,u=8,p=8;return e.prototype.move=function(e){var o=this;o.cordinats=e,o.firstMove=!1},e.prototype.death=function(){var e=this;e.cordinats=void 0,e.isDead=!0},o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.getAvailableMoves=function(e){var o,r,t,l,i=this,c=i.moveSettings,s=[],n=i.cordinats;return c.movesDescr.forEach(function(a){for(o=1;o<=c.moveLength;o++)if(r=o*a.row+n.row,t=o*a.col+n.col,l=a.custom?{figureId:i.id,color:i.color,position:n,dest:{row:r,col:t},type:a.custom}:{figureId:i.id,color:i.color,position:n,dest:{row:r,col:t},kill:!0,basic:!0},r>0&&r<=u&&t>0&&t<=p&&s.push(l),!c.jump){var v=_.find(e,{row:r,col:t})||{};if(v.figure)break}}),s},r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.getAvailableMoves=function(e){function o(e){var o=e.dest.row>0&&e.dest.row<=u,r=e.dest.col>0&&e.dest.col<=p;if(o&&r)return!0}var r,t,l,i=this,c=[],s=i.cordinats;switch(i.color){case"white":t=1;break;case"black":t=-1}r={figureId:i.id,color:i.color,position:s,dest:{row:1*t+s.row,col:0+s.col},kill:!1,basic:!0},o(r)&&c.push(r),i.firstMove&&(r={figureId:i.id,color:i.color,position:s,dest:{row:2*t+s.row,col:0+s.col},kill:!1,basic:!0,passing:!0},o(r)&&c.push(r));for(var n=1;n<=2;n++){switch(n){case 1:l=1;break;case 2:l=-1}r={figureId:i.id,color:i.color,position:s,dest:{row:1*t+s.row,col:1*l+s.col},kill:!0,basic:!1},o(r)&&c.push(r)}return c},t.prototype=Object.create(o.prototype),t.prototype.constructor=t,l.prototype=Object.create(o.prototype),l.prototype.constructor=l,i.prototype=Object.create(o.prototype),i.prototype.constructor=i,c.prototype=Object.create(o.prototype),c.prototype.constructor=c,s.prototype=Object.create(o.prototype),s.prototype.constructor=s,s.prototype.getAvailableMoves=function(e){var r=this;return r.firstMove&&r.moveSettings.movesDescr.push({row:0,col:2,custom:{name:"castling",long:!1}},{row:0,col:-2,custom:{name:"castling",long:!0}}),o.prototype.getAvailableMoves.apply(r,arguments)},n}angular.module("chessApp.common").factory("figureService",e)}(),function(){"use strict";function e(){function e(e,o,r,t){function l(){s(),n(),a(),v.figures[0]&&(v.bindFigures(),v.getAvailableMoves(v.cells))}function i(e,o){for(var r=[],t=e.charCodeAt(0),l=o.charCodeAt(0),i=t;i<=l;i++)r.push(String.fromCharCode(i));return r}function c(e,o){for(var r=[],t=e;t<=o;t++)r.push(t);return r}function s(){for(v.rows=[],p=0;p<e;p++)v.rows.push({row:p+1,cells:[],firstCellBlack:d}),d=!d;v.rows=v.rows.reverse()}function n(){v.rows.forEach(function(e){for(p=0;p<o;p++){var r={row:e.row,col:p+1,black:e.firstCellBlack,cellName:u(p+1)+e.row};0===p&&(r.rowName=e.row),1===e.row&&(r.colName=u(p+1)),e.cells.push(r),e.firstCellBlack=!e.firstCellBlack}})}function a(){v.cells=[],_.each(v.rows,function(e){v.cells.push(e.cells)}),v.cells=_.flatten(v.cells)}function u(e){if(e<=w.cols.length)return w.cols[e-1];throw new Error("unexpected number of columns")}var p,v=this,g=i("a","z"),f=c(1,26),d=!0,w={rows:f.slice(0,e),cols:g.slice(0,o)};v.whiteTurn=!0,v.player1=r||{},v.player2=t||{},v.figures=_.concat(v.player1.figures,v.player2.figures),v.movesLog=[],v.deadFigures=[],l()}var o={constructor:e};return e.prototype.bindFigures=function(){var e=this;_.each(e.figures,function(o){_.find(e.cells,o.cordinats).figure=o})},e.prototype.getAvailableMoves=function(e){var o=this;o.availableMoves=[],_.each(o.figures,function(r,t){o.availableMoves.push(r.getAvailableMoves(e)),t===o.figures.length-1&&(o.availableMoves=_.flatten(o.availableMoves))})},e.prototype.removeFigure=function(e){var o=this,r=o.figures.indexOf(e);o.deadFigures.push(e),o.figures.splice(r,1)},e.prototype.start=function(){var e=this;e.player1.defaultStart(),e.player2.defaultStart(),e.figures=_.concat(e.player1.figures,e.player2.figures),e.bindFigures(),e.getAvailableMoves(e.cells),e.gameIsStarted=!0},e.prototype.restart=function(){var e=this;e.cells.forEach(function(e){e.figure&&delete e.figure}),e.player1.restart(),e.player2.restart(),e.whiteTurn=!0,e.movesLog=[],e.deadFigures=[],e.figures=_.concat(e.player1.figures,e.player2.figures),e.bindFigures(),e.getAvailableMoves(e.cells)},e.prototype.validateMove=function(e){var o=this;if(o.movesLog.length)var r=o.movesLog[o.movesLog.length-1];var t={startCell:_.find(o.cells,e.position),finishCell:_.find(o.cells,e.dest),dest:e.dest,availableMove:_.find(o.availableMoves,e)},l=t.startCell.figure,i=t.finishCell.figure;if(!(t.startCell.figure.isBlack&&o.whiteTurn||!t.startCell.figure.isBlack&&!o.whiteTurn)&&t.availableMove){if(!i&&t.availableMove.basic)return t.typeOfMove="basic",t.availableMove.passing&&(t.typeOfMove="passing",t.passingThrow={col:t.finishCell.col},l.isBlack?t.passingThrow.row=t.finishCell.row+1:t.passingThrow.row=t.finishCell.row-1),t;if(i&&t.availableMove.kill&&i.isBlack!=l.isBlack)return t.typeOfMove="killMove",t;if(r&&"passing"===r.typeOfMove){var c=_.find(o.figures,{id:r.figureId});if(t.secondFigure=c,"pawn"===l.name&&t.availableMove.kill&&l.isBlack!==c.isBlack){var s=t.availableMove.dest.col===r.passingThrow.col&&t.availableMove.dest.row===r.passingThrow.row;if(s)return t.typeOfMove="inPassingKill",t.secondFigureCell=_.find(o.cells,{figure:c}),t}}var n,a,u=!0,p=!0;if(t.availableMove.type&&"castling"===t.availableMove.type.name){if(a="white"===l.color?"black":"white",t.availableMove.type.long?t.secondFigureCell=n=_.find(o.cells,{row:e.position.row,col:e.position.col-4}):t.secondFigureCell=n=_.find(o.cells,{row:e.position.row,col:e.position.col+3}),!n.figure||"Rook"!==n.figure.name||!n.figure.firstMove)return;t.secondFigure=n.figure,t.typeOfMove=t.availableMove.type,t.availableMove.type.long?t.secondFigureDest={row:n.row,col:n.col+3}:t.secondFigureDest={row:n.row,col:n.col-2};var v=o.checkCellsLine(t.startCell,n,!0);if(v.forEach(function(e,r){var l=_.find(o.availableMoves,{color:a,kill:!0,dest:{row:e.row,col:e.col}});t.availableMove.type.long&&0===r&&(l=void 0),e.figure&&(u=!1),l&&(p=!1)}),p&&u)return t}}},e.prototype.checkCellsLine=function(e,o,r){var t=this,l=[],i={},c=Math.abs(e.row-o.row),s=Math.abs(e.col-o.col);if(e.row===o.row){i.row=e.row,i.col=Math.min(e.col,o.col);for(var n=0;n<=s;n++)l.push(_.find(t.cells,{row:i.row,col:i.col+n}))}if(e.col===o.col){i.row=Math.min(e.row,o.row),i.col=e.col;for(var n=0;n<=c;n++)l.push(_.find(t.cells,{row:i.row+n,col:i.col}))}return r&&(l.shift(),l.pop()),l},e.prototype.makeMove=function(e){var o=this,r={};if(e){var t=e.startCell.figure;"killMove"===e.typeOfMove&&(e.finishCell.figure.death(),o.removeFigure(e.finishCell.figure),delete e.finishCell.figure),t.move(e.dest),e.secondFigure&&("castling"===e.typeOfMove.name&&e.secondFigure.move(e.secondFigureDest),"inPassingKill"===e.typeOfMove&&(e.secondFigure.death(),o.removeFigure(e.secondFigure)),delete e.secondFigureCell.figure),delete e.startCell.figure,r={startCell:e.startCell,finishCell:e.finishCell,typeOfMove:e.typeOfMove,figureId:t.id,color:t.color},"passing"===e.typeOfMove&&(r.passingThrow=e.passingThrow),o.movesLog.push(r),o.bindFigures(),o.getAvailableMoves(o.cells),o.whiteTurn=!o.whiteTurn}},o}angular.module("chessApp.common").service("boardService",e)}();