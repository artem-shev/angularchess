!function(){"use strict";angular.module("chessApp",["ngRoute","ngAnimate","chessApp.common"])}(),function(){"use strict";function e(){var e={templateUrl:"components/chessboard/chessboard.html",controller:"MainCtrl",controllerAs:"ctrl"};return e}angular.module("chessApp").directive("chessboard",e)}(),function(){"use strict";function e(e,o,r){function l(e,o){if(!c.position){if(!o.figure)return;return i=o,i.isSelected=!0,c.figureId=i.figure.id,void(c.position={row:o.row,coll:o.coll})}c.dest={row:o.row,coll:o.coll};var r=t.board.validateMove(c);t.board.makeMove(r),delete i.isSelected,c={},i=void 0}var t=this;t.player1=new r.constructor,t.player2=new r.constructor;var i,c={};t.board=new o.constructor(8,8,t.player1,t.player2),t.selectCell=l}angular.module("chessApp").controller("MainCtrl",e),e.$inject=["figureService","boardService","userService"]}(),angular.module("chessApp").run(["$templateCache",function(e){e.put("components/chessboard/chessboard.html",'<div class="set">\r\n\t<div class="controlls">\r\n\t\t<p><button ng-click="ctrl.board.start()">Start</button></p>\r\n\t\t<p><button ng-click="ctrl.board.restart()">Restart</button></p>\r\n\t</div>\t\r\n\t<div class="info">\r\n\t\t<div>\r\n\t\t\t<div ng-if="ctrl.player1">\r\n\t\t\t\tPlayer 1: <br>\r\n\t\t\t\tname: {{ctrl.player1.name}}\r\n\t\t\t\t<!-- value, time, killed figures -->\r\n\t\t\t</div>\r\n\t\t\t<br>\r\n\t\t\t<div ng-if="ctrl.player2">\r\n\t\t\t\tPlayer 2: <br>\r\n\t\t\t\tname: {{ctrl.player2.name}}\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n<div class="board">\r\n\t<div ng-repeat="row in ctrl.board.rows" class="row">\r\n\t\t<div ng-repeat="cell in row.cells" class="cell" ng-class="{\'black-cell\': cell.black}" ng-click="ctrl.selectCell($event, cell)">\r\n\t\t\t<img ng-if="cell.figure" ng-src="{{cell.figure.img}}" alt="" class="figure">\r\n\t\t\t\r\n\t\t\t<div ng-if="cell.rowName" class="row-name">{{cell.rowName}}</div>\r\n\t\t\t<div ng-if="cell.collName" class="coll-name">{{cell.collName}}</div>\r\n\t\t\t<div ng-if="cell.isSelected" class="selected"></div>\r\n\t\t</div>\t\t\t\r\n\t</div>\t\r\n</div>\r\n')}]),function(){"use strict";angular.module("chessApp.common",[])}(),function(){"use strict"}(),function(){"use strict";function e(e){function o(e){var o,r=this;o=i?"black":"white",r.isBlack=i,r.name=e||o+" player",r.figures=[],i=!i}var r={constructor:o},l=e.constructors,t=[l.Rook,l.Knight,l.Bishop,l.Queen,l.King,l.Bishop,l.Knight,l.Rook],i=!1;return o.prototype.defaultStart=function(){var e,o,r=this;r.isBlack?(e=8,o=7):(e=1,o=2),t.forEach(function(t,i){r.figures.push(new t(r,{row:e,coll:i+1})),r.figures.push(new l.Pawn(r,{row:o,coll:i+1}))})},o.prototype.restart=function(){var e=this;e.figures=[],e.defaultStart()},r}angular.module("chessApp.common").factory("userService",e),e.$inject=["figureService"]}(),function(){"use strict";function e(){function e(e,o){var r=this;r.isBlack=e.isBlack,r.cordinats=o,r.firstMove=!0,r.id=n,n++}function o(o,r){var l=this;e.apply(l,arguments)}function r(o,r){var l=this;e.apply(l,arguments),l.name="pawn",l.value=1,l.isBlack?(l.color="black",l.img="img/bP.png"):(l.color="white",l.img="img/wP.png")}function l(e,r){var l=this;o.apply(l,arguments),l.name="Bishop",l.value=3,l.isBlack?(l.color="black",l.img="img/bB.png"):(l.color="white",l.img="img/wB.png")}function t(e,r){var l=this;o.apply(l,arguments),l.name="Knight",l.value=3,l.isBlack?(l.color="black",l.img="img/bN.png"):(l.color="white",l.img="img/wN.png")}function i(e,r){var l=this;o.apply(l,arguments),l.name="Rook",l.value=5,l.isBlack?(l.color="black",l.img="img/bR.png"):(l.color="white",l.img="img/wR.png")}function c(e,r){var l=this;o.apply(l,arguments),l.name="Queen",l.value=9,l.isBlack?(l.color="black",l.img="img/bQ.png"):(l.color="white",l.img="img/wQ.png")}function s(e,r){var l=this;o.apply(l,arguments),l.name="King",l.isBlack?(l.color="black",l.img="img/bK.png"):(l.color="white",l.img="img/wK.png")}var a={constructors:{Pawn:r,Bishop:l,Knight:t,Rook:i,Queen:c,King:s}},n=1,u=8,p=8;return e.prototype.move=function(e){var o=this;o.cordinats=e,o.firstMove=!1},e.prototype.death=function(){var e=this;e.cordinats=void 0,e.isDead=!0},o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.getAvailableMoves=function(e,o){var r,l,t,i,c=this,s=[],a=c.cordinats;return e.movesDescr.forEach(function(n){for(r=1;r<=e.moveLength;r++)if(l=r*n.row+a.row,t=r*n.coll+a.coll,i=n.custom?{figureId:c.id,color:c.color,position:a,dest:{row:l,coll:t},type:n.custom}:{figureId:c.id,color:c.color,position:a,dest:{row:l,coll:t},kill:!0,basic:!0},l>0&&l<=u&&t>0&&t<=p&&s.push(i),!e.jump){var v=_.find(o,{row:l,coll:t})||{};if(v.figure)break}}),s},r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.getAvailableMoves=function(){function e(e){var o=e.dest.row>0&&e.dest.row<=u,r=e.dest.coll>0&&e.dest.coll<=p;return!(!o||!r)||void console.log("false",!1)}var o,r,l,t=this,i=[],c=t.cordinats;switch(t.color){case"white":r=1;break;case"black":r=-1}o={figureId:t.id,color:t.color,position:c,dest:{row:1*r+c.row,coll:0+c.coll},kill:!1,basic:!0},e(o)&&i.push(o),t.firstMove&&(o={figureId:t.id,color:t.color,position:c,dest:{row:2*r+c.row,coll:0+c.coll},kill:!1,basic:!0,passing:!0},e(o)&&i.push(o));for(var s=1;s<=2;s++){switch(s){case 1:l=1;break;case 2:l=-1}o={figureId:t.id,color:t.color,position:c,dest:{row:1*r+c.row,coll:1*l+c.coll},kill:!0,basic:!1},e(o)&&i.push(o)}return i},l.prototype=Object.create(o.prototype),l.prototype.constructor=l,l.prototype.getAvailableMoves=function(e){var r=this,l={movesDescr:[{row:1,coll:1},{row:1,coll:-1},{row:-1,coll:1},{row:-1,coll:-1}],moveLength:8,jump:!1};return o.prototype.getAvailableMoves.apply(r,[l,e])},t.prototype=Object.create(o.prototype),t.prototype.constructor=t,t.prototype.getAvailableMoves=function(e){var r=this,l={movesDescr:[{row:2,coll:1},{row:2,coll:-1},{row:-2,coll:1},{row:-2,coll:-1},{row:1,coll:2},{row:-1,coll:2},{row:1,coll:-2},{row:-1,coll:-2}],moveLength:1,jump:!0};return o.prototype.getAvailableMoves.apply(r,[l,e])},i.prototype=Object.create(o.prototype),i.prototype.constructor=i,i.prototype.getAvailableMoves=function(e){var r=this,l={movesDescr:[{row:0,coll:1},{row:0,coll:-1},{row:1,coll:0},{row:-1,coll:0}],moveLength:8,jump:!1};return o.prototype.getAvailableMoves.apply(r,[l,e])},c.prototype=Object.create(o.prototype),c.prototype.constructor=c,c.prototype.getAvailableMoves=function(e){var r=this,l={movesDescr:[{row:0,coll:1},{row:0,coll:-1},{row:1,coll:0},{row:-1,coll:0},{row:1,coll:1},{row:-1,coll:-1},{row:-1,coll:1},{row:1,coll:-1}],moveLength:8,jump:!1};return o.prototype.getAvailableMoves.apply(r,[l,e])},s.prototype=Object.create(o.prototype),s.prototype.constructor=s,s.prototype.getAvailableMoves=function(e){var r=this,l={movesDescr:[{row:1,coll:1},{row:1,coll:0},{row:1,coll:-1},{row:0,coll:-1},{row:-1,coll:-1},{row:-1,coll:0},{row:-1,coll:1},{row:0,coll:1}],moveLength:1,jump:!1};return r.firstMove&&l.movesDescr.push({row:0,coll:2,custom:{name:"castling",long:!1}},{row:0,coll:-2,custom:{name:"castling",long:!0}}),o.prototype.getAvailableMoves.apply(r,[l,e])},a}angular.module("chessApp.common").factory("figureService",e)}(),function(){"use strict";function e(){function e(e,o,r,l){function t(){s(),a(),n(),v.figures[0]&&(v.bindFigures(),v.getAvailableMoves(v.cells))}function i(e,o){for(var r=[],l=e.charCodeAt(0),t=o.charCodeAt(0),i=l;i<=t;i++)r.push(String.fromCharCode(i));return r}function c(e,o){for(var r=[],l=e;l<=o;l++)r.push(l);return r}function s(){for(v.rows=[],p=0;p<e;p++)v.rows.push({row:p+1,cells:[],firstCellBlack:d}),d=!d;v.rows=v.rows.reverse()}function a(){v.rows.forEach(function(e){for(p=0;p<o;p++){var r={row:e.row,coll:p+1,black:e.firstCellBlack,cellName:u(p+1)+e.row};0===p&&(r.rowName=e.row),1===e.row&&(r.collName=u(p+1)),e.cells.push(r),e.firstCellBlack=!e.firstCellBlack}})}function n(){v.cells=[],_.each(v.rows,function(e){v.cells.push(e.cells)}),v.cells=_.flatten(v.cells)}function u(e){if(e<=w.colls.length)return w.colls[e-1];throw new Error("unexpected number of collumns")}var p,v=this,f=i("a","z"),g=c(1,26),d=!0,w={rows:g.slice(0,e),colls:f.slice(0,o)};v.whiteTurn=!0,v.player1=r||{},v.player2=l||{},v.figures=_.concat(v.player1.figures,v.player2.figures),v.movesLog=[],v.deadFigures=[],t()}var o={constructor:e};return e.prototype.bindFigures=function(){var e=this;_.each(e.figures,function(o){_.find(e.cells,o.cordinats).figure=o})},e.prototype.getAvailableMoves=function(e){var o=this;o.availableMoves=[],_.each(o.figures,function(r,l){o.availableMoves.push(r.getAvailableMoves(e)),l===o.figures.length-1&&(o.availableMoves=_.flatten(o.availableMoves))})},e.prototype.removeFigure=function(e){var o=this,r=o.figures.indexOf(e);o.deadFigures.push(e),o.figures.splice(r,1)},e.prototype.start=function(){var e=this;e.player1.defaultStart(),e.player2.defaultStart(),e.figures=_.concat(e.player1.figures,e.player2.figures),e.bindFigures(),e.getAvailableMoves(e.cells)},e.prototype.restart=function(){var e=this;e.cells.forEach(function(e){e.figure&&delete e.figure}),e.player1.restart(),e.player2.restart(),e.whiteTurn=!0,e.movesLog=[],e.deadFigures=[],e.figures=_.concat(e.player1.figures,e.player2.figures),e.bindFigures(),e.getAvailableMoves(e.cells)},e.prototype.validateMove=function(e){var o=this;if(o.movesLog.length)var r=o.movesLog[o.movesLog.length-1];var l={startCell:_.find(o.cells,e.position),finishCell:_.find(o.cells,e.dest),dest:e.dest,availableMove:_.find(o.availableMoves,e)},t=l.startCell.figure,i=l.finishCell.figure;if(!(l.startCell.figure.isBlack&&o.whiteTurn||!l.startCell.figure.isBlack&&!o.whiteTurn)&&l.availableMove){if(!i&&l.availableMove.basic)return l.typeOfMove="basic",l.availableMove.passing&&(l.typeOfMove="passing",l.passingThrow={coll:l.finishCell.coll},t.isBlack?l.passingThrow.row=l.finishCell.row+1:l.passingThrow.row=l.finishCell.row-1),l;if(i&&l.availableMove.kill&&i.isBlack!=t.isBlack)return l.typeOfMove="killMove",l;if(r&&"passing"===r.typeOfMove){var c=_.find(o.figures,{id:r.figureId});if(l.secondFigure=c,"pawn"===t.name&&l.availableMove.kill&&t.isBlack!==c.isBlack){var s=l.availableMove.dest.coll===r.passingThrow.coll&&l.availableMove.dest.row===r.passingThrow.row;if(s)return l.typeOfMove="inPassingKill",l.secondFigureCell=_.find(o.cells,{figure:c}),l}}var a,n,u=!0,p=!0;if(l.availableMove.type&&"castling"===l.availableMove.type.name){if(n="white"===t.color?"black":"white",l.availableMove.type.long?l.secondFigureCell=a=_.find(o.cells,{row:e.position.row,coll:e.position.coll-4}):l.secondFigureCell=a=_.find(o.cells,{row:e.position.row,coll:e.position.coll+3}),!a.figure||"Rook"!==a.figure.name||!a.figure.firstMove)return;l.secondFigure=a.figure,l.typeOfMove=l.availableMove.type,l.availableMove.type.long?l.secondFigureDest={row:a.row,coll:a.coll+3}:l.secondFigureDest={row:a.row,coll:a.coll-2};var v=o.checkCellsLine(l.startCell,a,!0);if(v.forEach(function(e,r){var t=_.find(o.availableMoves,{color:n,kill:!0,dest:{row:e.row,coll:e.coll}});l.availableMove.type.long&&0===r&&(t=void 0),e.figure&&(u=!1),t&&(p=!1)}),p&&u)return l}}},e.prototype.checkCellsLine=function(e,o,r){var l=this,t=[],i={},c=Math.abs(e.row-o.row),s=Math.abs(e.coll-o.coll);if(e.row===o.row){i.row=e.row,i.coll=Math.min(e.coll,o.coll);for(var a=0;a<=s;a++)t.push(_.find(l.cells,{row:i.row,coll:i.coll+a}))}if(e.coll===o.coll){i.row=Math.min(e.row,o.row),i.coll=e.coll;for(var a=0;a<=c;a++)t.push(_.find(l.cells,{row:i.row+a,coll:i.coll}))}return r&&(t.shift(),t.pop()),t},e.prototype.makeMove=function(e){var o=this,r={};if(e){var l=e.startCell.figure;"killMove"===e.typeOfMove&&(e.finishCell.figure.death(),o.removeFigure(e.finishCell.figure),delete e.finishCell.figure),l.move(e.dest),e.secondFigure&&("castling"===e.typeOfMove.name&&e.secondFigure.move(e.secondFigureDest),"inPassingKill"===e.typeOfMove&&(e.secondFigure.death(),o.removeFigure(e.secondFigure)),delete e.secondFigureCell.figure),delete e.startCell.figure,r={startCell:e.startCell,finishCell:e.finishCell,typeOfMove:e.typeOfMove,figureId:l.id,color:l.color},"passing"===e.typeOfMove&&(r.passingThrow=e.passingThrow),o.movesLog.push(r),o.bindFigures(),o.getAvailableMoves(o.cells),o.whiteTurn=!o.whiteTurn}},o}angular.module("chessApp.common").service("boardService",e)}();